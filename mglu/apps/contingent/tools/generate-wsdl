#!/bin/sh

pushd wsdl

# generate server (contingent.rb, contingentServant.rb, contingent.cgi) and client (contingentDriver.rb)
ruby ./wsdl2ruby.rb --wsdl contingent.wsdl --classdef --servant_skelton --cgi_stub --driver

# post-process them
ruby -e 'puts "# Generated by generate-wsdl. Do not edit!"; puts; $stdin.gets; $stdin.each_line { |l| print l unless l =~ /soap\/rpc\/cgistub/; exit if l.chop == "end" }' <contingent.cgi >stub.rb
echo '# Generated by generate-wsdl. Do not edit!' >default2.rb
echo >>default2.rb
echo 'module ContingentSOAP' >>default2.rb
cat contingent.rb >>default2.rb
echo 'end' >>default2.rb
rm -f contingent.cgi contingent.rb
mv default2.rb default.rb
subst "s/require 'contingent.rb'/require 'default.rb'/" contingentDriver.rb

# install generated files where they belong
# don't move defaultServant.rb, as it will overwrite human-written code
cp -f default.rb ../../tests/soap
mv -f contingentDriver.rb ../../tests/soap
mv -f default.rb stub.rb ../../soap
cp -f contingent-presentation.wsdl ../../static/contingent.wsdl

popd
